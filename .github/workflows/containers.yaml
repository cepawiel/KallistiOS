name: Build Docker Images

on:
  push:
    branches: [master]
    # paths:
    #   - 'gcc-base/**'
    #   - 'gcc-toolchain/**'
    #   - 'kos-toolchain/**'
    #   - 'kos-toolchain-cmake/**'
    
jobs:
  # define job to build and publish containers
  build-container-sh4-toolchain-deps:
    name: Build Container for SH4 GCC Build Deps
    runs-on: ubuntu-latest

    outputs:
      outcome: ${{ steps.status.outcome }}

    # steps to perform in job
    steps:
      - name: Checkout Source
        uses: actions/checkout@v2
        with:
          # get preciding commit for use with changed-files
          fetch-depth: 2

      # setup Docker build action
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      # authenticate with GHCR
      - name: Login to GHCR
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}
      
      # get changed files
      - id: changed-files
        uses: tj-actions/changed-files@v18
        with:
          files: |
            ./.github/workflows/containers.yaml
            ./utils/containers/gcc-prereqs/Dockerfile

      # only build if any if files were changed
      - name: Build+Push dc-gcc-prereqs
        id: build-image
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: docker/build-push-action@v2
        with:
          context: ./utils/containers/gcc-prereqs
          tags: |
            ghcr.io/cepawiel/dc-gcc-prereqs:latest
          push: true

      # set output variable
      - id: status
        run: echo "::set-output name=outcome::${{steps.build-image.outcome}}"

  build-container-sh4-toolchain:
    needs: build-container-sh4-toolchain-deps
    name: Build Container for SH4 GCC
    runs-on: ubuntu-latest

    outputs:
      outcome: ${{ steps.status.outcome }}

    # steps to perform in job
    steps:
      - name: Checkout Source
        uses: actions/checkout@v2
        with:
          # get preciding commit for use with changed-files
          fetch-depth: 2

      - run: echo 

      # setup Docker build action
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      # authenticate with GHCR
      - name: Login to GHCR
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}
      
      # get changed files
      - id: changed-files
        uses: tj-actions/changed-files@v18
        with:
          files: |
            ./.github/workflows/containers.yaml
            ./utils/dc-chain/**
            ./utils/container/gcc-toolchain/Dockerfile

      - name: Build+Push dc-gcc-toolchain
        id: build-image
        if: |
          steps.changed-files.outputs.any_changed == 'true' ||
          ${{ needs.build-container-sh4-toolchain-deps.outputs.outcome }} == 'success'
        uses: docker/build-push-action@v2
        with:
          context: ./utils/containers/gcc-toolchain
          tags: |
            ghcr.io/cepawiel/dc-gcc-toolchain:latest
          push: true

      # set output variable
      - id: status
        run: echo "::set-output name=outcome::${{steps.build-image.outcome}}"

  # TODO: Seperate out ports from this image
  build-container-kos-toolchain:
    needs: build-container-sh4-toolchain
    name: Build Container for KOS GCC
    runs-on: ubuntu-latest

    outputs:
      outcome: ${{ steps.status.outcome }}

    # steps to perform in job
    steps:
      - name: Checkout Source
        uses: actions/checkout@v2
        with:
          # get preciding commit for use with changed-files
          fetch-depth: 2

      # setup Docker build action
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      # authenticate with GHCR
      - name: Login to GHCR
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}
      
     # get changed files
      - id: changed-files
        uses: tj-actions/changed-files@v18
        with:
          files: |
            ./.github/workflows/containers.yaml
            ./utils/dc-chain/**
            ./utils/containers/kos-toolchain/Dockerfile

      - name: Build+Push dc-kos-toolchain
        id: build-image
        if: |
          steps.changed-files.outputs.any_changed == 'true' ||
          ${{ needs.build-container-sh4-toolchain.outputs.outcome }} == 'success'
        uses: docker/build-push-action@v2
        with:
          context: ./utils/containers/kos-toolchain
          tags: |
            ghcr.io/cepawiel/dc-kos-toolchain:latest
          push: true

      # set output variable
      - id: status
        run: echo "::set-output name=outcome::${{steps.build-image.outcome}}"

  # TODO: create image with ports
  # TODO: Image with cmake